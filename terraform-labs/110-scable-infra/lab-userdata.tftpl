#!/bin/bash -ex

dnf update -y
dnf install -y httpd wget php-fpm php-mysqli php-json php php-devel mariadb105 unzip

systemctl enable httpd
systemctl start httpd

cd /var/www/html

# ì•± ë‹¤ìš´ë¡œë“œ
wget -q https://aws-largeobjects.s3.ap-northeast-2.amazonaws.com/AWS-AcademyACF/lab7-app-php7.zip
unzip -o lab7-app-php7.zip -d /var/www/html/

# ê¶Œí•œ ì •ë¦¬
chown -R apache:apache /var/www/html
chmod -R 755 /var/www/html

# rds.conf.php ìƒì„± (rds.phpê°€ includeí•´ì„œ ì”€)
cat > /var/www/html/rds.conf.php <<EOF
<?php
\$RDS_URL  = "${rds_endpoint}";
\$RDS_DB   = "mydb";
\$RDS_user = "${db_username}";
\$RDS_pwd  = "${db_password}";
?>
EOF

chmod 664 /var/www/html/rds.conf.php

# Health Check
echo "OK" > /var/www/html/health
chmod 644 /var/www/html/health

########################################
# ğŸ”¹ RDS ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
########################################
for i in {1..30}; do
  if mysql -u "${db_username}" -p"${db_password}" -h "${rds_endpoint}" -P 3306 -e "SELECT 1;" >/dev/null 2>&1; then
    echo "RDS is ready"
    break
  fi
  echo "Waiting for RDS... ($i/30)"
  sleep 10
done

########################################
# ğŸ”¹ DB / í…Œì´ë¸” / ì´ˆê¸° ë°ì´í„° ì„¸íŒ…
########################################
mysql -u "${db_username}" -p"${db_password}" -h "${rds_endpoint}" -P 3306\
  -e "CREATE DATABASE IF NOT EXISTS mydb;" || true


########################################
# TABLE ìƒì„± í™•ì¸ í›„ ì—†ìœ¼ë©´ import
########################################

# í…Œì´ë¸” ì¡´ì¬ í™•ì¸
CHECK=$(mysql -u "${db_username}" -p"${db_password}" -h "${rds_endpoint}" -P 3306\
  -e "SHOW TABLES FROM mydb LIKE 'address';" | grep address || true)

if [ -z "$CHECK" ]; then
  echo "[INFO] No table found. Importing SQL..."
  mysql -u "${db_username}" -p"${db_password}" -h "${rds_endpoint}" -P 3306\
    mydb < /var/www/html/sql/addressbook.sql
else
  echo "[INFO] Table already exists. Skip import."
fi